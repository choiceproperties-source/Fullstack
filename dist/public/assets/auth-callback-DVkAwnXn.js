import{r as u,j as e}from"./ui-DbSH5uIw.js";import{z as P,N as f,C as x,n as T,K as h,Y as R,c as U,ae as o}from"./index-C3yA2dmm.js";import"./vendor-15WF5uYg.js";import"./query-C11-Me4M.js";import"./charts-DfbWf95P.js";async function g(t){return"renter"}function Y(){const[,t]=P(),[p,a]=u.useState(null),[_,n]=u.useState(!0),[k,v]=u.useState(!1);return u.useEffect(()=>{const C=async()=>{try{if(!o){a("Authentication service unavailable"),n(!1);return}const s=new URLSearchParams(window.location.hash.substring(1)),b=s.get("access_token"),j=s.get("refresh_token"),w=s.get("error_description"),y=s.get("type");if(w){const r=decodeURIComponent(w);console.error("[Auth Callback] Error from Supabase:",r),r.includes("expired")?a("This verification link has expired. Please request a new one."):r.includes("invalid")?a("This verification link is invalid. Please request a new one."):a(r),n(!1);return}if(b&&j){const{data:r,error:m}=await o.auth.setSession({access_token:b,refresh_token:j});if(m){console.error("[Auth Callback] Session error:",m),a(m.message),n(!1);return}if(r.user){if(localStorage.removeItem("pending_verification_email"),(y==="signup"||y==="email_change"||!!r.user.email_confirmed_at)&&r.user.email_confirmed_at){console.log("[Auth Callback] Email verified successfully"),v(!0);const d=r.user.id;setTimeout(async()=>{const i=await g(d);l(i)},2e3);return}const E=new Date(r.user.created_at),A=new Date().getTime()-E.getTime()<6e4,{data:c}=await o.from("users").select("id, role").eq("id",r.user.id).single();if(!c){const{error:d}=await o.from("users").upsert({id:r.user.id,email:r.user.email,full_name:r.user.user_metadata?.full_name||r.user.user_metadata?.name||null,profile_image:r.user.user_metadata?.avatar_url||null,role:r.user.user_metadata?.role||null},{onConflict:"id"});d&&console.error("[Auth Callback] Failed to create user profile:",d);const i=r.user.user_metadata?.role;if(i&&i!=="user"){l(i);return}t("/select-role");return}if((!c.role||c.role==="user")&&A){t("/select-role");return}const S=c.role||await g(r.user.id);l(S);return}}const{data:{session:N}}=await o.auth.getSession();if(N?.user){const r=await g(N.user.id);l(r);return}a("Authentication failed. Please try signing in again."),n(!1)}catch(s){console.error("[Auth Callback] Unexpected error:",s),a(s.message||"An unexpected error occurred. Please try again."),n(!1)}},l=s=>{t(s==="agent"?"/agent-dashboard":s==="admin"?"/admin":s==="landlord"||s==="property_manager"?"/seller-dashboard":"/")};C()},[t]),k?e.jsxs("div",{className:"min-h-screen bg-background flex flex-col",children:[e.jsx(f,{}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-4 bg-gradient-to-br from-primary/5 to-secondary/5",children:e.jsxs(x,{className:"max-w-md w-full p-8 shadow-xl text-center border-t-4 border-t-green-500",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(T,{className:"h-8 w-8 text-green-500"})}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Email Verified!"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Your email has been verified successfully."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Redirecting you to the app..."})]})}),e.jsx(h,{})]}):_?e.jsxs("div",{className:"min-h-screen bg-background flex flex-col",children:[e.jsx(f,{}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-4 bg-gradient-to-br from-primary/5 to-secondary/5",children:e.jsxs(x,{className:"max-w-md w-full p-8 shadow-xl text-center",children:[e.jsx("div",{className:"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Completing Sign In..."}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we complete your authentication."})]})}),e.jsx(h,{})]}):p?e.jsxs("div",{className:"min-h-screen bg-background flex flex-col",children:[e.jsx(f,{}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-4 bg-gradient-to-br from-primary/5 to-secondary/5",children:e.jsxs(x,{className:"max-w-md w-full p-8 shadow-xl border-t-4 border-t-red-500 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Authentication Failed"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:p}),e.jsx(R,{href:"/login",children:e.jsx(U,{className:"w-full","data-testid":"button-try-again",children:"Try Again"})})]})}),e.jsx(h,{})]}):null}export{Y as default};
