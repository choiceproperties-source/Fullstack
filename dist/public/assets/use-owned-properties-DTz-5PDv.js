import{r as m}from"./ui-DbSH5uIw.js";import{u as v,a as p,_ as h}from"./index-C3yA2dmm.js";function O(){const{user:d}=v(),{toast:r}=p(),[l,n]=m.useState([]),[w,g]=m.useState(!1),[P,u]=m.useState(null);return m.useEffect(()=>{if(!d){const e=JSON.parse(localStorage.getItem("choiceProperties_ownedProperties")||"[]");n(e);return}(async()=>{g(!0),u(null);try{const e=await h(),s=await fetch(`/api/v2/properties?ownerId=${d.id}`,{headers:{Authorization:e?`Bearer ${e}`:""}});if(!s.ok)throw new Error("Failed to fetch properties");const o=(await s.json())?.data,c=Array.isArray(o)?o:o?.properties||[];n(c)}catch(e){const s=e instanceof Error?e.message:"Error fetching properties";u(s);const t=JSON.parse(localStorage.getItem("choiceProperties_ownedProperties")||"[]");n(t)}finally{g(!1)}})()},[d]),{properties:l,loading:w,error:P,createProperty:async i=>{if(!d){const e=JSON.parse(localStorage.getItem("choiceProperties_ownedProperties")||"[]"),s={id:`prop_${Date.now()}`,ownerId:"local",...i,createdAt:new Date().toISOString()},t=[...e,s];return localStorage.setItem("choiceProperties_ownedProperties",JSON.stringify(t)),n(t),r({title:"Success",description:"Property added"}),s}try{const e=await h();if(i.images&&Array.isArray(i.images)){for(const a of i.images)if(typeof a!="string"||!a.startsWith("http"))throw new Error("Invalid image format: all images must be ImageKit URLs")}const s={title:i.title,description:i.description,address:i.address,city:i.city,state:i.state,zipCode:i.zipCode,price:i.price?.toString(),bedrooms:i.bedrooms,bathrooms:i.bathrooms?.toString(),squareFeet:i.squareFeet,propertyType:i.propertyType,petsAllowed:i.petsAllowed,leaseTerm:i.leaseTerm,utilitiesIncluded:i.utilitiesIncluded,amenities:i.amenities,images:i.images||[],furnished:i.furnished,status:i.status,ownerId:d.id},t=await fetch("/api/v2/properties",{method:"POST",headers:{"Content-Type":"application/json",Authorization:e?`Bearer ${e}`:""},body:JSON.stringify(s)});if(!t.ok){const a=await t.json().catch(()=>({}));throw new Error(a.error||"Failed to create property")}const o=await t.json(),c=o.data||o;return n([...l,c]),r({title:"Success",description:"Property created successfully"}),c}catch(e){const s=e instanceof Error?e.message:"Error creating property";return u(s),r({title:"Error",description:s,variant:"destructive"}),null}},updateProperty:async(i,e)=>{if(!d){const s=l.map(t=>t.id===i?{...t,...e,updatedAt:new Date().toISOString()}:t);return localStorage.setItem("choiceProperties_ownedProperties",JSON.stringify(s)),n(s),r({title:"Success",description:"Property updated"}),s.find(t=>t.id===i)||null}try{const s=await h(),t={};e.title!==void 0&&(t.title=e.title),e.description!==void 0&&(t.description=e.description),e.address!==void 0&&(t.address=e.address),e.city!==void 0&&(t.city=e.city),e.state!==void 0&&(t.state=e.state),e.zipCode!==void 0&&(t.zipCode=e.zipCode),e.price!==void 0&&(t.price=e.price?.toString()),e.bedrooms!==void 0&&(t.bedrooms=e.bedrooms),e.bathrooms!==void 0&&(t.bathrooms=e.bathrooms?.toString()),e.squareFeet!==void 0&&(t.squareFeet=e.squareFeet),e.propertyType!==void 0&&(t.propertyType=e.propertyType),e.petsAllowed!==void 0&&(t.petsAllowed=e.petsAllowed),e.leaseTerm!==void 0&&(t.leaseTerm=e.leaseTerm),e.utilitiesIncluded!==void 0&&(t.utilitiesIncluded=e.utilitiesIncluded),e.amenities!==void 0&&(t.amenities=e.amenities),e.images!==void 0&&(t.images=e.images),e.furnished!==void 0&&(t.furnished=e.furnished),e.status!==void 0&&(t.status=e.status);const o=await fetch(`/api/v2/properties/${i}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:s?`Bearer ${s}`:""},body:JSON.stringify(t)});if(!o.ok){const f=await o.json().catch(()=>({}));throw o.status===403?new Error("You do not have permission to edit this property"):new Error(f.error||"Failed to update property")}const c=await o.json(),a=c.data||c,S=l.map(f=>f.id===i?a:f);return n(S),r({title:"Success",description:"Property updated"}),a}catch(s){const t=s instanceof Error?s.message:"Error updating property";return u(t),r({title:"Error",description:t,variant:"destructive"}),null}},deleteProperty:async i=>{if(!d){const e=l.filter(s=>s.id!==i);return localStorage.setItem("choiceProperties_ownedProperties",JSON.stringify(e)),n(e),r({title:"Success",description:"Property deleted"}),!0}try{const e=await h();if(!(await fetch(`/api/v2/properties/${i}`,{method:"DELETE",headers:{Authorization:e?`Bearer ${e}`:""}})).ok)throw new Error("Failed to delete property");return n(l.filter(t=>t.id!==i)),r({title:"Success",description:"Property deleted"}),!0}catch(e){const s=e instanceof Error?e.message:"Error deleting property";return u(s),r({title:"Error",description:s,variant:"destructive"}),!1}}}}export{O as u};
