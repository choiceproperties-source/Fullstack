import{r as o,j as e}from"./ui-DbSH5uIw.js";import{u as A,a as w}from"./query-C11-Me4M.js";import{u as ae,a as te,z as ne,N as E,C as b,c as d,K as $,aj as C,D as ie,b as re,aD as le,d as ce,J as oe,e as de,X as p,I as u,Q as ue,F as k,as as xe,l as q,b6 as F,L as me,ay as M,az as T,aA as S,B as pe,aa as Q,aB as K,W as he,s as h,r as I}from"./index-C3yA2dmm.js";import{A as je}from"./arrow-left-DiT6yHBU.js";import{S as ge}from"./send-Cf7U_e2v.js";import"./vendor-15WF5uYg.js";import"./charts-DfbWf95P.js";function Me(){const{user:r,isLoggedIn:D}=ae(),{toast:x}=te(),[,O]=ne(),[n,j]=o.useState(null),[m,L]=o.useState(""),[g,R]=o.useState(""),[B,_]=o.useState(!1),[t,l]=o.useState({participantId:"",propertyId:"",subject:"",initialMessage:""}),{data:z,isLoading:H}=A({queryKey:["/api/conversations"],enabled:D}),U=z?.data||[],{data:W,isLoading:J}=A({queryKey:["/api/conversations",n],enabled:!!n&&D}),i=W?.data,f=w({mutationFn:async s=>(await I("POST",`/api/conversations/${s.conversationId}/messages`,{content:s.content})).json(),onSuccess:()=>{L(""),h.invalidateQueries({queryKey:["/api/conversations",n]}),h.invalidateQueries({queryKey:["/api/conversations"]})},onError:()=>{x({title:"Error",description:"Failed to send message",variant:"destructive"})}}),v=w({mutationFn:async s=>(await I("POST","/api/conversations",s)).json(),onSuccess:s=>{_(!1),l({participantId:"",propertyId:"",subject:"",initialMessage:""}),h.invalidateQueries({queryKey:["/api/conversations"]}),s?.data?.id&&j(s.data.id),x({title:"Success",description:"Conversation started"})},onError:()=>{x({title:"Error",description:"Failed to create conversation",variant:"destructive"})}}),X=w({mutationFn:async s=>(await I("PATCH",`/api/conversations/${s}/read`)).json(),onSuccess:()=>{h.invalidateQueries({queryKey:["/api/conversations"]})}}),G=s=>{j(s),X.mutate(s)},V=s=>{s.preventDefault(),!(!m.trim()||!n)&&f.mutate({conversationId:n,content:m.trim()})},Y=()=>{if(!t.participantId||!t.initialMessage.trim()){x({title:"Error",description:"Please select a recipient and enter a message",variant:"destructive"});return}v.mutate({participantIds:[t.participantId],propertyId:t.propertyId||void 0,subject:t.subject||void 0,initialMessage:t.initialMessage})},P=U.filter(s=>{if(!g)return!0;const a=g.toLowerCase(),c=s.subject?.toLowerCase().includes(a),y=s.properties?.title?.toLowerCase().includes(a),ee=s.participants?.some(se=>se.users?.full_name?.toLowerCase().includes(a));return c||y||ee}),Z=s=>s.participants?.filter(a=>a.user_id!==r?.id)||[],N=s=>s?s.split(" ").map(a=>a[0]).join("").toUpperCase().slice(0,2):"?";return r?e.jsxs("div",{className:"min-h-screen flex flex-col bg-background",children:[e.jsx(E,{}),e.jsxs("main",{className:"flex-1 container mx-auto px-4 py-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4 mb-6 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(C,{className:"h-8 w-8 text-primary"}),e.jsx("h1",{className:"text-2xl font-bold","data-testid":"text-page-title",children:"Messages"})]}),e.jsxs(ie,{open:B,onOpenChange:_,children:[e.jsx(re,{asChild:!0,children:e.jsxs(d,{"data-testid":"button-new-conversation",children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"New Message"]})}),e.jsxs(ce,{children:[e.jsx(oe,{children:e.jsx(de,{children:"Start New Conversation"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Subject (optional)"}),e.jsx(u,{"data-testid":"input-conversation-subject",placeholder:"What is this about?",value:t.subject,onChange:s=>l(a=>({...a,subject:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Recipient ID"}),e.jsx(u,{"data-testid":"input-recipient-id",placeholder:"Enter recipient user ID",value:t.participantId,onChange:s=>l(a=>({...a,participantId:s.target.value}))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Enter the user ID of the person you want to message"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Related Property (optional)"}),e.jsx(u,{"data-testid":"input-property-id",placeholder:"Enter property ID if related to a property",value:t.propertyId,onChange:s=>l(a=>({...a,propertyId:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Message"}),e.jsx(ue,{"data-testid":"input-initial-message",placeholder:"Type your message...",value:t.initialMessage,onChange:s=>l(a=>({...a,initialMessage:s.target.value})),rows:4})]}),e.jsx(d,{className:"w-full",onClick:Y,disabled:v.isPending,"data-testid":"button-send-new-message",children:v.isPending?"Sending...":"Start Conversation"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-250px)] min-h-[500px]",children:[e.jsxs(b,{className:"lg:col-span-1 flex flex-col",children:[e.jsx(k,{className:"pb-3",children:e.jsxs("div",{className:"relative",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(u,{"data-testid":"input-search-conversations",placeholder:"Search conversations...",className:"pl-10",value:g,onChange:s=>R(s.target.value)})]})}),e.jsx(q,{className:"flex-1 p-0",children:e.jsx(F,{className:"h-full",children:H?e.jsxs("div",{className:"p-4 flex items-center justify-center gap-2 text-muted-foreground",role:"status",children:[e.jsx(me,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Loading conversations..."})]}):P.length===0?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(C,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No conversations yet"})]})}):e.jsx("div",{className:"divide-y",children:P.map(s=>{const c=Z(s)[0]?.users,y=n===s.id;return e.jsx("button",{"data-testid":`button-conversation-${s.id}`,className:`w-full p-4 text-left transition-colors hover-elevate ${y?"bg-accent":""}`,onClick:()=>G(s.id),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs(M,{className:"h-10 w-10",children:[e.jsx(T,{src:c?.profile_image||void 0}),e.jsx(S,{children:N(c?.full_name)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:c?.full_name||"Unknown"}),s.unreadCount&&s.unreadCount>0&&e.jsx(pe,{variant:"default",className:"shrink-0","data-testid":`badge-unread-${s.id}`,children:s.unreadCount})]}),s.subject&&e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.subject}),s.lastMessage&&e.jsx("p",{className:"text-sm text-muted-foreground truncate mt-1",children:s.lastMessage.content}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[s.properties&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(Q,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate max-w-[100px]",children:s.properties.title})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:K(new Date(s.updated_at),"MMM d")})]})]})]})},s.id)})})})})]}),e.jsx(b,{className:"lg:col-span-2 flex flex-col",children:n&&i?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"border-b",children:e.jsx("div",{className:"flex items-center justify-between gap-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(d,{variant:"ghost",size:"icon",className:"lg:hidden",onClick:()=>j(null),children:e.jsx(je,{className:"h-4 w-4"})}),e.jsx(M,{className:"h-10 w-10",children:e.jsx(S,{children:N(i.participants?.find(s=>s.user_id!==r?.id)?.users?.full_name)})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold","data-testid":"text-conversation-title",children:i.subject||i.participants?.find(s=>s.user_id!==r?.id)?.users?.full_name||"Conversation"}),i.properties&&e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[e.jsx(Q,{className:"h-3 w-3"}),i.properties.title]})]})]})})}),e.jsxs(q,{className:"flex-1 p-0 flex flex-col min-h-0",children:[e.jsx(F,{className:"flex-1 p-4",children:J?e.jsx("div",{className:"text-center text-muted-foreground py-4",children:"Loading messages..."}):e.jsx("div",{className:"space-y-4",children:i.messages?.map(s=>{const a=s.sender_id===r?.id;return e.jsx("div",{"data-testid":`message-${s.id}`,className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] ${a?"order-2":"order-1"}`,children:[!a&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs(M,{className:"h-6 w-6",children:[e.jsx(T,{src:s.users?.profile_image||void 0}),e.jsx(S,{children:N(s.users?.full_name)})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.users?.full_name})]}),e.jsx("div",{className:`rounded-lg px-4 py-2 ${a?"bg-primary text-primary-foreground":"bg-muted"}`,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content})}),e.jsx("p",{className:`text-xs text-muted-foreground mt-1 ${a?"text-right":""}`,children:K(new Date(s.created_at),"MMM d, h:mm a")})]})},s.id)})})}),e.jsx(he,{}),e.jsx("form",{onSubmit:V,className:"p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{"data-testid":"input-message",placeholder:"Type a message...",value:m,onChange:s=>L(s.target.value),disabled:f.isPending}),e.jsx(d,{type:"submit",size:"icon",disabled:!m.trim()||f.isPending,"data-testid":"button-send-message",children:e.jsx(ge,{className:"h-4 w-4"})})]})})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(C,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Select a conversation to view messages"}),e.jsx("p",{className:"text-sm mt-2",children:"or start a new conversation"})]})})})]})]}),e.jsx($,{})]}):e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(E,{}),e.jsx("main",{className:"flex-1 flex items-center justify-center",children:e.jsxs(b,{className:"p-6",children:[e.jsx("p",{className:"text-muted-foreground",children:"Please log in to view messages"}),e.jsx(d,{className:"mt-4",onClick:()=>O("/login"),children:"Log In"})]})}),e.jsx($,{})]})}export{Me as default};
